name: Build and Test ARM64 Fedora bootc for Raspberry Pi 5

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  REGISTRY_USER: rh-ee-chbutler
  IMAGE_REGISTRY: quay.io
  IMAGE: flightradar-bootc-pi

jobs:
  build-and-test:
    runs-on: ubuntu-24.04-arm
    container:
      image: registry.access.redhat.com/ubi9/ubi
      options: --privileged    
    permissions:
      contents: read
      packages: read

    steps:
    - name: Get container tools in UBI builder
      run: dnf -y install podman buildah skopeo make wget git

    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Workaround open podman-login action issue
      env:
        auth: "{ \"auths\": {} }"
      run: |
        mkdir -p $HOME/.docker
        echo $auth > $HOME/.docker/config.json

    - name: Build container image (no push)
      id: build-image
      uses: redhat-actions/buildah-build@v2
      with:
        image: "${{ env.IMAGE }}"
        tags: test ${{ github.sha }}
        platforms: linux/arm64
        containerfiles: |
          ./Containerfile


    - name: Test container functionality
      run: |
        # Test image was built successfully
        echo "Testing built image: ${{ env.IMAGE }}:test"
        podman image inspect ${{ env.IMAGE }}:test --format '{{.Id}}'
        
        
        # Verify the image contains expected files using buildah mount (avoids nested containers)
        CONTAINER=$(buildah from ${{ env.IMAGE }}:test)
        MOUNT=$(buildah mount $CONTAINER)
        
        # Test that scripts exist and are executable
        test -x "$MOUNT/usr/local/bin/wifi-setup.sh"
        test -x "$MOUNT/usr/local/bin/tailscale-setup.sh"
        
        # Test that node-exporter config exists
        test -f "$MOUNT/etc/containers/systemd/node-exporter.container"
        
        # Test that required packages are installed (check RPM database)
        chroot "$MOUNT" rpm -q tailscale NetworkManager-wifi podman >/dev/null
        
        # Clean up
        buildah unmount $CONTAINER
        buildah rm $CONTAINER
        
        echo "âœ… All container functionality tests passed"